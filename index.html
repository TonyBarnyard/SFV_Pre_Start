<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shotfirer Pre-Start</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        .hidden { display: none; }
        /* Red border for Service Mode to alert user */
        .service-mode { border: 2px solid #dc3545; background-color: #fff8f8; }
        /* Full screen loader */
        .loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.98); z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; }
        .btn-xl { padding: 15px; font-size: 1.2rem; font-weight: bold; }
    </style>
</head>
<body class="bg-light">

<script>
    // --- YOUR SPECIFIC GOOGLE SCRIPT URL ---
    const API_URL = "https://script.google.com/macros/s/AKfycbw6xtbL7QPCvM-D4fjw6HHBo1UgEnPq4b1UEe3m9agZKwT7iTCtoxO0rU1LZdhd5QHqCw/exec"; 
</script>

<div id="loader" class="loader">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
    <p class="mt-3 fw-bold text-secondary" id="loader-text">Connecting to HQ...</p>
</div>

<div class="container py-3" style="max-width: 600px;">
    
    <div class="text-center mb-4">
        <img id="logo-img" src="" style="max-height: 80px; display:none;" class="mb-2">
        <h4 id="veh-title" class="fw-bold">Vehicle Pre-Start</h4>
        <button class="btn btn-sm btn-link text-decoration-none" onclick="showQR()">Admin: Show QR Code</button>
    </div>

    <form id="app-form" onsubmit="submitForm(event)">
        
        <div class="card shadow-sm mb-3 border-primary">
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label fw-bold text-muted small">VEHICLE</label>
                    <select id="vehicle" class="form-select form-select-lg" onchange="updateUI()" required>
                        <option value="" disabled selected>Loading...</option>
                    </select>
                </div>
                
                <div id="asset-photo" class="text-center mb-3 hidden">
                    <img src="" style="max-height: 140px; border-radius: 5px; border: 1px solid #ccc;">
                </div>

                <div class="row g-2">
                    <div class="col-7">
                        <label class="form-label fw-bold text-muted small">OPERATOR</label>
                        <select id="driver" class="form-select" required>
                            <option value="">Loading...</option>
                        </select>
                    </div>
                    <div class="col-5">
                        <label class="form-label fw-bold text-muted small">PIN</label>
                        <input type="password" id="pin" class="form-control" placeholder="****" inputmode="numeric" required>
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-3">
            <label class="fw-bold">Mode</label>
            <select id="mode" class="form-select" onchange="toggleMode()">
                <option value="DAILY">Daily Pre-Start (Explosives)</option>
                <option value="SERVICE">Service Handover (Workshop)</option>
            </select>
        </div>

        <div id="daily-checks">
            <div class="mb-3">
                <label>Current Load Type</label>
                <select id="load_type" class="form-select">
                    <option>Mixed (>250kg HE + Dets)</option>
                    <option>HE Only</option>
                    <option>Dets Only</option>
                    <option>Empty (Returning)</option>
                </select>
            </div>
            
            <h6 class="border-bottom pb-2 mt-4 text-primary">AEC Compliance</h6>
            <div class="form-check py-2 border-bottom"><input type="checkbox" class="form-check-input" required><label class="form-check-label">Manifest & EPG Current/Dated</label></div>
            <div class="form-check py-2 border-bottom"><input type="checkbox" class="form-check-input" required><label class="form-check-label">Placards Visible (Front & Rear)</label></div>
            <div class="form-check py-2 border-bottom"><input type="checkbox" class="form-check-input" required><label class="form-check-label">Segregation: Detonators Locked</label></div>
            <div class="form-check py-2 border-bottom"><input type="checkbox" class="form-check-input" required><label class="form-check-label">2x Fire Extinguishers Charged</label></div>
            <div class="form-check py-2 border-bottom"><input type="checkbox" class="form-check-input" required><label class="form-check-label">Boxes Clean (No Residue)</label></div>
            
            <h6 class="border-bottom pb-2 mt-4 text-primary">Vehicle Condition</h6>
            <div class="form-check py-2 border-bottom"><input type="checkbox" class="form-check-input" required><label class="form-check-label">Tyres / Lights / Brakes</label></div>
            <div class="form-check py-2 border-bottom"><input type="checkbox" class="form-check-input" required><label class="form-check-label">Two-Way Radio Functional</label></div>
        </div>

        <div id="service-checks" class="hidden p-3 mb-3 bg-white border border-danger rounded shadow-sm">
            <h5 class="text-danger fw-bold text-center">Explosives Clearance</h5>
            <p class="small text-center text-muted mb-3">Check required before workshop entry.</p>
            
            <div class="form-check py-2 border-bottom">
                <input type="checkbox" class="form-check-input" id="s1">
                <label class="form-check-label fw-bold">HE Box (Boosters) EMPTY</label>
            </div>
            <div class="form-check py-2 border-bottom">
                <input type="checkbox" class="form-check-input" id="s2">
                <label class="form-check-label fw-bold">Detonator Box EMPTY</label>
            </div>
            <div class="form-check py-2">
                <input type="checkbox" class="form-check-input" id="s3">
                <label class="form-check-label">Compartments Swept Clean</label>
            </div>
        </div>

        <div class="mb-3 mt-4">
            <label class="form-label fw-bold">Photo Evidence / Faults</label>
            <input type="file" id="photo" class="form-control" accept="image/*" capture="environment">
        </div>
        <div class="mb-3">
            <textarea id="notes" class="form-control" rows="3" placeholder="Enter fault notes here..."></textarea>
        </div>
        
        <input type="hidden" id="gps">
        <button type="submit" id="btn-submit" class="btn btn-primary w-100 btn-xl shadow">SUBMIT CHECK</button>
    </form>

    <div id="qr-panel" class="hidden text-center mt-5 pt-4 border-top">
        <h5>Vehicle QR Code</h5>
        <div id="qrcode" class="d-flex justify-content-center my-3"></div>
        <button onclick="window.location.reload()" class="btn btn-secondary w-100">Close</button>
    </div>
</div>

<script>
    let vehiclesDB = [];
    const loader = document.getElementById('loader');
    const loaderText = document.getElementById('loader-text');

    // 1. INITIALIZE SYSTEM
    window.onload = function() {
        // Attempt GPS
        if(navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                pos => { document.getElementById('gps').value = pos.coords.latitude + "," + pos.coords.longitude; },
                err => { console.log("GPS Denied"); }
            );
        }

        // Fetch Data from Google
        fetch(API_URL)
        .then(res => res.json())
        .then(data => {
            // Logo
            if(data.logo) { 
                document.getElementById('logo-img').src = data.logo; 
                document.getElementById('logo-img').style.display = 'inline'; 
            }
            
            // Vehicles
            vehiclesDB = data.vehicles;
            let vSel = document.getElementById('vehicle');
            vSel.innerHTML = '<option value="" disabled selected>Select Vehicle...</option>';
            data.vehicles.forEach(v => {
                let opt = document.createElement('option');
                opt.value = v[0]; // ID
                opt.text = v[0] + " (" + v[1] + ")";
                vSel.add(opt);
            });

            // Operators
            let dSel = document.getElementById('driver');
            dSel.innerHTML = '<option value="" disabled selected>Select Name...</option>';
            data.operators.forEach(op => {
                let opt = document.createElement('option');
                opt.value = op; opt.text = op; dSel.add(opt);
            });

            // Check for QR Code Link
            const urlParams = new URLSearchParams(window.location.search);
            const vid = urlParams.get('vid');
            if(vid) { 
                vSel.value = vid; 
                updateUI(); 
            }

            loader.classList.add('hidden');
        })
        .catch(err => {
            loaderText.innerText = "Error Connecting to System.";
            alert("Connection Failed. Please reload.");
        });
    };

    // 2. UI UPDATES
    function updateUI() {
        const vid = document.getElementById('vehicle').value;
        const veh = vehiclesDB.find(v => v[0] === vid);
        
        document.getElementById('veh-title').innerText = vid ? vid + " Pre-Start" : "Vehicle Pre-Start";
        
        const imgDiv = document.getElementById('asset-photo');
        if(veh && veh[2]) { 
            imgDiv.querySelector('img').src = veh[2]; 
            imgDiv.classList.remove('hidden'); 
        } else { 
            imgDiv.classList.add('hidden'); 
        }
    }

    function toggleMode() {
        const isSvc = document.getElementById('mode').value === 'SERVICE';
        
        document.getElementById('daily-checks').classList.toggle('hidden', isSvc);
        document.getElementById('service-checks').classList.toggle('hidden', !isSvc);
        
        // Toggle Required Fields
        const dailyInp = document.getElementById('daily-checks').querySelectorAll('input');
        const svcInp = document.getElementById('service-checks').querySelectorAll('input');
        dailyInp.forEach(i => i.required = !isSvc);
        svcInp.forEach(i => i.required = isSvc);
        
        // Update Button
        const btn = document.getElementById('btn-submit');
        if(isSvc) {
            btn.className = "btn btn-danger w-100 btn-xl shadow";
            btn.innerText = "SIGN OVER FOR SERVICE";
        } else {
            btn.className = "btn btn-primary w-100 btn-xl shadow";
            btn.innerText = "SUBMIT CHECK";
        }
    }

    // 3. SUBMIT FORM
    async function submitForm(e) {
        e.preventDefault();
        const btn = document.getElementById('btn-submit');
        
        btn.disabled = true;
        loader.classList.remove('hidden');
        loaderText.innerText = "Verifying PIN...";

        const driver = document.getElementById('driver').value;
        const pin = document.getElementById('pin').value;

        // VERIFY PIN
        try {
            const req = await fetch(API_URL + "?action=verify&name=" + encodeURIComponent(driver) + "&pin=" + pin);
            const res = await req.json();
            
            if(!res.valid) {
                throw new Error("Invalid PIN Number");
            }
        } catch(err) {
            loader.classList.add('hidden');
            alert("❌ Access Denied: " + err.message);
            btn.disabled = false;
            return;
        }

        // PREPARE DATA
        loaderText.innerText = "Generating PDF & Emailing...";
        
        let photoData = "";
        const fileInput = document.getElementById('photo');
        if(fileInput.files.length > 0) photoData = await toBase64(fileInput.files[0]);

        let checks = "";
        const divId = document.getElementById('mode').value === 'SERVICE' ? 'service-checks' : 'daily-checks';
        document.getElementById(divId).querySelectorAll('.form-check').forEach(div => {
            const cb = div.querySelector('input');
            const lbl = div.querySelector('label').innerText;
            if(cb.checked) checks += `☑ ${lbl}<br>`;
        });

        const vid = document.getElementById('vehicle').value;
        const veh = vehiclesDB.find(v => v[0] === vid);

        const payload = {
            vehicle: vid,
            rego: veh ? veh[1] : "",
            driver: driver,
            mode: document.getElementById('mode').value,
            load_type: document.getElementById('load_type').value,
            gps: document.getElementById('gps').value,
            notes: document.getElementById('notes').value,
            checks: checks,
            photo: photoData
        };

        // SEND (No-Cors Mode)
        fetch(API_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify(payload)
        }).then(() => {
            loader.classList.add('hidden');
            document.body.innerHTML = `
                <div class="d-flex flex-column justify-content-center align-items-center vh-100 text-center bg-success text-white">
                    <h1 class="display-1">✔</h1>
                    <h2>Success</h2>
                    <p class="lead">Document emailed to supervisor.</p>
                    <button onclick="window.location.reload()" class="btn btn-light btn-lg mt-4">New Entry</button>
                </div>
            `;
        }).catch(err => {
            loader.classList.add('hidden');
            alert("Network Error. Please try again.");
            btn.disabled = false;
        });
    }

    // 4. ADMIN QR GENERATOR
    function showQR() {
        const vid = document.getElementById('vehicle').value;
        if(!vid) return alert("Select vehicle first.");
        
        document.getElementById('qrcode').innerHTML = "";
        const url = window.location.href.split('?')[0] + "?vid=" + vid;
        new QRCode(document.getElementById("qrcode"), { text: url, width: 150, height: 150 });
        
        document.getElementById('qr-panel').classList.remove('hidden');
        document.getElementById('app-form').classList.add('hidden');
    }

    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
</script>
</body>
</html>
